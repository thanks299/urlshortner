<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>URL Shortener</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080808; --surface: #101010; --surface2: #141414;
      --border: #1c1c1c; --border2: #262626;
      --accent: #e8ff47; --accent2: #ff6b35;
      --text: #efefef; --muted: #888; --muted2: #555;
      --green: #4effa0; --red: #ff5c5c; --amber: #ffbe5c; --blue: #5cb8ff;
    }
    body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; }
    body::before {
      content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:radial-gradient(circle,rgba(232,255,71,.05) 1px,transparent 1px);
      background-size:36px 36px;
    }
    .wrap { max-width:820px; margin:0 auto; padding:0 28px 80px; position:relative; z-index:1; }

    /* HEADER */
    header { padding:44px 0 36px; display:flex; align-items:flex-end; justify-content:space-between; border-bottom:1px solid var(--border); margin-bottom:40px; }
    .logo { font-family:'Bebas Neue',sans-serif; font-size:68px; letter-spacing:6px; line-height:1; color:var(--accent); text-shadow:0 0 50px rgba(232,255,71,.18); }
    .logo em { color:var(--accent2); font-style:normal; }
    .header-meta { padding-bottom:6px; text-align:right; }
    .tagline { font-family:'DM Mono',monospace; font-size:10px; text-transform:uppercase; letter-spacing:2.5px; color:var(--muted); margin-bottom:8px; }
    .pills { display:flex; gap:5px; flex-wrap:wrap; justify-content:flex-end; }
    .pill { font-family:'DM Mono',monospace; font-size:9px; text-transform:uppercase; letter-spacing:1px; padding:2px 8px; border:1px solid var(--border2); border-radius:20px; color:var(--muted2); }

    /* TABS */
    .tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:32px; }
    .tab { font-family:'DM Mono',monospace; font-size:11px; text-transform:uppercase; letter-spacing:2px; padding:11px 22px; cursor:pointer; color:var(--muted); background:none; border:none; border-bottom:2px solid transparent; margin-bottom:-1px; transition:color .15s; }
    .tab:hover { color:var(--text); }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .panel { display:none; } .panel.active { display:block; }

    /* CARD */
    .card { background:var(--surface); border:1px solid var(--border); border-radius:3px; padding:30px; margin-bottom:18px; position:relative; overflow:hidden; }
    .card-top::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,var(--accent),var(--accent2)); }

    /* FORM */
    .fg { margin-bottom:18px; }
    .lbl { font-family:'DM Mono',monospace; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:var(--muted); display:block; margin-bottom:7px; }
    .lbl small { float:right; font-size:9px; text-transform:none; letter-spacing:0; color:var(--muted2); font-style:italic; }
    input[type=url], input[type=text], input[type=datetime-local] {
      width:100%; background:var(--bg); border:1px solid var(--border2); color:var(--text);
      font-family:'DM Mono',monospace; font-size:14px; padding:12px 14px;
      outline:none; border-radius:2px; transition:border-color .15s, box-shadow .15s; -webkit-appearance:none;
    }
    input:focus { border-color:var(--accent); box-shadow:0 0 0 2px rgba(232,255,71,.06); }
    input::placeholder { color:#383838; }
    input[type=datetime-local]::-webkit-calendar-picker-indicator { filter:invert(.35); }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .pfx-wrap { position:relative; }
    .pfx { position:absolute; left:13px; top:50%; transform:translateY(-50%); font-family:'DM Mono',monospace; font-size:12px; color:var(--accent); pointer-events:none; }
    .pfx-wrap input { padding-left:138px; }

    /* TOGGLE */
    .tog { display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:14px; user-select:none; background:none; border:none; padding:0; font-family:inherit; color:inherit; }
    .tog-sw { width:38px; height:21px; background:var(--border2); border-radius:11px; position:relative; flex-shrink:0; transition:background .18s; }
    .tog-sw::after { content:''; position:absolute; top:3px; left:3px; width:15px; height:15px; background:#444; border-radius:50%; transition:left .18s, background .18s; }
    .tog.on .tog-sw { background:rgba(232,255,71,.2); }
    .tog.on .tog-sw::after { left:20px; background:var(--accent); }
    .tog-lbl { font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }
    .tog.on .tog-lbl { color:var(--text); }
    .collapse { display:none; }
    .collapse.open { display:block; animation:sd .18s ease; }
    @keyframes sd { from{opacity:0;transform:translateY(-5px)} to{opacity:1;transform:none} }

    /* BUTTON */
    .btn-main { width:100%; background:var(--accent); color:#080808; font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:2px; padding:13px; border:none; border-radius:2px; cursor:pointer; margin-top:22px; transition:transform .12s, box-shadow .12s; }
    .btn-main:hover { transform:translateY(-2px); box-shadow:0 6px 26px rgba(232,255,71,.18); }
    .btn-main:active { transform:none; }
    .btn-main:disabled { opacity:.4; pointer-events:none; }
    .btn-sm { font-family:'DM Mono',monospace; font-size:11px; text-transform:uppercase; letter-spacing:1.5px; padding:7px 14px; border:1px solid var(--border2); background:transparent; color:var(--muted); border-radius:2px; cursor:pointer; transition:all .15s; }
    .btn-sm:hover { border-color:var(--accent); color:var(--accent); }
    .btn-sm.ok { border-color:var(--green); color:var(--green); }
    .btn-icon { background:transparent; border:1px solid var(--border2); color:var(--muted); font-size:13px; padding:4px 9px; border-radius:2px; cursor:pointer; transition:all .15s; font-family:'DM Mono',monospace; }
    .btn-icon:hover { border-color:var(--accent); color:var(--accent); }
    .btn-icon.del:hover { border-color:var(--red); color:var(--red); }

    /* RESULT */
    .result { margin-top:18px; border:1px solid var(--green); background:rgba(78,255,160,.04); border-radius:2px; padding:18px 20px; display:none; }
    .result.show { display:block; animation:fu .2s ease; }
    .result.err { border-color:var(--red); background:rgba(255,92,92,.04); }
    .result.warn { border-color:var(--amber); background:rgba(255,190,92,.04); }
    @keyframes fu { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
    .r-tag { font-family:'DM Mono',monospace; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:var(--green); margin-bottom:8px; }
    .result.err .r-tag { color:var(--red); }
    .result.warn .r-tag { color:var(--amber); }
    .r-url { font-family:'DM Mono',monospace; font-size:19px; margin-bottom:12px; word-break:break-all; line-height:1.3; }
    .r-meta { font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); margin-bottom:12px; line-height:1.9; }
    .r-meta span { color:var(--text); }
    .r-acts { display:flex; gap:8px; flex-wrap:wrap; }

    /* STATS TABLE */
    .sh { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .sh-title { font-family:'Bebas Neue',sans-serif; font-size:30px; letter-spacing:2px; }
    .tbl-wrap { background:var(--surface); border:1px solid var(--border); border-radius:3px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    thead th { font-family:'DM Mono',monospace; font-size:9px; text-transform:uppercase; letter-spacing:2px; color:var(--muted); padding:11px 14px; text-align:left; border-bottom:1px solid var(--border); background:var(--surface2); }
    tbody td { font-family:'DM Mono',monospace; font-size:13px; padding:13px 14px; border-bottom:1px solid rgba(255,255,255,.025); vertical-align:middle; }
    tbody tr:last-child td { border-bottom:none; }
    tbody tr:hover td { background:rgba(255,255,255,.015); }
    .td-code { color:var(--accent); font-size:14px; font-weight:500; }
    .td-url { max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--muted); }
    .td-url a { color:inherit; text-decoration:none; } .td-url a:hover { color:var(--text); }
    .td-clicks { text-align:right; }
    .bar { height:2px; background:rgba(232,255,71,.08); border-radius:1px; margin-top:5px; }
    .bar-fill { height:100%; background:var(--accent); border-radius:1px; transition:width .5s ease; }
    .badge { display:inline-block; font-family:'DM Mono',monospace; font-size:9px; text-transform:uppercase; letter-spacing:1px; padding:2px 7px; border-radius:20px; border:1px solid; }
    .b-active  { color:var(--green); border-color:rgba(78,255,160,.3); background:rgba(78,255,160,.05); }
    .b-expired { color:var(--red);   border-color:rgba(255,92,92,.3);  background:rgba(255,92,92,.05); }
    .b-soon    { color:var(--amber); border-color:rgba(255,190,92,.3); background:rgba(255,190,92,.05); }
    .b-noexp   { color:var(--muted2); border-color:var(--border2); }

    /* ANALYTICS DRAWER */
    .drawer-row { display:none; }
    .drawer { background:var(--surface2); border-top:1px solid var(--border2); }
    .drawer-hd { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); }
    .drawer-title { font-family:'DM Mono',monospace; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:var(--blue); }
    .log { max-height:220px; overflow-y:auto; }
    .log::-webkit-scrollbar { width:3px; } .log::-webkit-scrollbar-thumb { background:var(--border2); }
    .ce { display:grid; grid-template-columns:155px 1fr 100px; gap:10px; padding:9px 14px; border-bottom:1px solid rgba(255,255,255,.025); font-family:'DM Mono',monospace; font-size:11px; align-items:center; }
    .ce:last-child { border-bottom:none; }
    .ce-time { color:var(--muted); } .ce-ua { color:#444; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } .ce-ip { color:var(--blue); font-size:10px; text-align:right; }
    .no-clicks { padding:22px; text-align:center; font-family:'DM Mono',monospace; font-size:12px; color:#3a3a3a; }
    .empty { text-align:center; padding:56px 20px; color:var(--muted2); font-family:'DM Mono',monospace; font-size:13px; }
    .empty .empty-icon { display:block; font-family:'Bebas Neue',sans-serif; font-size:52px; color:var(--border2); margin-bottom:10px; letter-spacing:3px; }

    /* API DOCS */
    .api-pre { font-family:'DM Mono',monospace; font-size:13px; color:#999; line-height:1.9; white-space:pre-wrap; word-break:break-word; }

    /* SPINNER */
    .spin { display:inline-block; width:13px; height:13px; border:2px solid rgba(8,8,8,.2); border-top-color:#080808; border-radius:50%; animation:sp .5s linear infinite; }
    @keyframes sp { to{transform:rotate(360deg)} }

    footer { border-top:1px solid var(--border); margin-top:56px; padding:22px 0; text-align:center; font-family:'DM Mono',monospace; font-size:10px; color:#2a2a2a; text-transform:uppercase; letter-spacing:1.5px; }

    @media(max-width:600px) {
      .row2 { grid-template-columns:1fr; }
      .logo { font-size:50px; }
      header { flex-direction:column; align-items:flex-start; gap:14px; }
      .pills { justify-content:flex-start; }
      .ce { grid-template-columns:130px 1fr; } .ce-ip { display:none; }
    }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="logo" style="font-size:42px;letter-spacing:3px">URL SHORTENER</div>
    <div class="header-meta">
      <div class="tagline">URL Shortener</div>
      <div class="pills">
        <span class="pill">Shorten</span><span class="pill">Redirect</span>
        <span class="pill">Analytics</span><span class="pill">Expiry</span>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="tab('shorten')">Shorten</button>
    <button class="tab"        onclick="tab('dashboard')">Dashboard</button>
    <!-- <button class="tab"        onclick="tab('api')">API Docs</button> -->
  </div>

  <!-- â•â• SHORTEN â•â• -->
  <div class="panel active" id="p-shorten">
    <div class="card card-top">
      <div class="fg">
        <label class="lbl" for="longUrl">Destination URL <small>http or https only</small></label>
        <input type="url" id="longUrl" placeholder="https://example.com/very/long/path..." autocomplete="off" />
      </div>
      <div class="row2">
        <div>
          <button class="tog" id="t-custom" onclick="tog('t-custom','g-custom')">
            <div class="tog-sw"></div><span class="tog-lbl">Custom short code</span>
          </button>
          <div class="collapse" id="g-custom">
            <label class="lbl" for="customCode">Short code</label>
            <div class="pfx-wrap">
              <span class="pfx">localhost:3000/</span>
              <input type="text" id="customCode" placeholder="my-link" autocomplete="off" />
            </div>
          </div>
        </div>
        <div>
          <button class="tog" id="t-exp" onclick="tog('t-exp','g-exp')">
            <div class="tog-sw"></div><span class="tog-lbl">Set expiry date</span>
          </button>
          <div class="collapse" id="g-exp">
            <label class="lbl" for="expiresAt">Expires at</label>
            <input type="datetime-local" id="expiresAt" />
          </div>
        </div>
      </div>
      <button class="btn-main" id="snipBtn" onclick="shorten()">
        <span id="btnLabel">SHORTEN</span>
      </button>
      <div class="result" id="result">
        <div class="r-tag" id="r-tag"></div>
        <div class="r-url" id="r-url"></div>
        <div class="r-meta" id="r-meta"></div>
        <div class="r-acts" id="r-acts"></div>
      </div>
    </div>
  </div>

  <!-- â•â• DASHBOARD â•â• -->
  <div class="panel" id="p-dashboard">
    <div class="sh">
      <div class="sh-title">ALL LINKS</div>
      <div style="display:flex;gap:8px">
        <button class="btn-sm" onclick="loadStats()">â†» Refresh</button>
      </div>
    </div>
    <div class="tbl-wrap" id="statsEl">
      <div class="empty"><span class="empty-icon">Â·Â·Â·</span>Loadingâ€¦</div>
    </div>
  </div>

  <!-- â•â• API DOCS â•â•
  <div class="panel" id="p-api">
    <div class="card">
      <pre class="api-pre" id="apiPre">Loadingâ€¦</pre>
    </div>
  </div> -->

  <footer>URL Shortener</footer>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shortUrl = '';
let togState = {};
let openCode = null;

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = ['shorten','dashboard'];
function tab(name) {
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',TABS[i]===name));
  TABS.forEach(n=>{
    const p=document.getElementById('p-'+n);
    if(p)p.classList.toggle('active',n===name);
    }
  );
  if (name==='dashboard') loadStats();
}

// â”€â”€ Toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tog(id, gid) {
  togState[id] = !togState[id];
  document.getElementById(id).classList.toggle('on', togState[id]);
  document.getElementById(gid).classList.toggle('open', togState[id]);
  if (!togState[id]) {
    if (gid==='g-custom') document.getElementById('customCode').value='';
    if (gid==='g-exp')    document.getElementById('expiresAt').value='';
  }
}

// â”€â”€ Shorten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shorten() {
  const originalUrl = document.getElementById('longUrl').value.trim();
  const customCode  = togState['t-custom'] ? document.getElementById('customCode').value.trim() : undefined;
  const expiresAt   = togState['t-exp']    ? document.getElementById('expiresAt').value || undefined : undefined;
  const btn = document.getElementById('snipBtn');
  const res = document.getElementById('result');

  if (!originalUrl) return flash('err','âœ• Missing URL','Please paste a URL.','','');
  btn.disabled=true;
  document.getElementById('btnLabel').innerHTML='<span class="spin"></span>';
  res.classList.remove('show');

  try {
    const r = await fetch('/api/links',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({originalUrl,customCode,expiresAt})});
    const j = await r.json();
    if (!r.ok) { flash('err','âœ• Error',j.error||'Something went wrong.','',''); return; }
    const d = j.data;
    shortUrl = d.shortUrl;
    const expLine = d.expiresAt ? `<br>Expires: <span>${new Date(d.expiresAt).toLocaleString()}</span>` : '';
    flash('ok',
      d.existing ? 'â†© Already shortened' : 'âœ“ Shortened',
      d.shortUrl,
      `â†’ <span>${trunc(d.originalUrl,60)}</span><br>Clicks: <span>${d.clicks}</span>${expLine}`,
      `<button class="btn-sm" id="cpBtn" onclick="cp()">Copy link</button>
       <button class="btn-sm" onclick="window.open(${JSON.stringify(d.shortUrl)},'_blank')">Open â†—</button>
       <button class="btn-sm" onclick="resetForm()">Shorten another</button>`
    );
  } catch { flash('err','âœ• Network error','Could not reach server.','',''); }
  finally { btn.disabled=false; document.getElementById('btnLabel').textContent='SHORTEN'; }
}

function flash(type, tag, url, meta, acts) {
  const el = document.getElementById('result');
  el.className = 'result show' + (type==='ok'?'':' '+type);
  document.getElementById('r-tag').textContent = tag;
  document.getElementById('r-url').textContent = type==='ok' ? url : '';
  document.getElementById('r-meta').innerHTML  = type==='ok' ? meta : `<span style="color:var(--red)">${url}</span>`;
  document.getElementById('r-acts').innerHTML  = acts;
}

function cp() {
  navigator.clipboard.writeText(shortUrl).then(()=>{
    const b=document.getElementById('cpBtn'); if(!b)return;
    b.textContent='âœ“ Copied!'; b.classList.add('ok');
    setTimeout(()=>{b.textContent='Copy link';b.classList.remove('ok');},2000);
  });
}

function resetForm() {
  document.getElementById('longUrl').value='';
  document.getElementById('result').classList.remove('show');
  shortUrl='';
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  const el=document.getElementById('statsEl');
  el.innerHTML='<div class="empty"><span class="empty-icon">Â·Â·Â·</span>Loadingâ€¦</div>';
  openCode=null;
  try {
    const r=await fetch('/api/links'); const j=await r.json();
    render(j.data?.links||[]);
  } catch { el.innerHTML='<div class="empty">Failed to load.</div>'; }
}

function render(links) {
  const el=document.getElementById('statsEl');
  if (!links.length) { el.innerHTML='<div class="empty"><span class="empty-icon">âˆ…</span>No links yet. Snip something!</div>'; return; }
  const max=Math.max(...links.map(l=>l.clicks),1);
  el.innerHTML=`<table>
    <thead><tr>
      <th>Code</th><th>Destination</th><th>Status</th><th>Created</th>
      <th style="text-align:right">Clicks</th><th style="text-align:right">Actions</th>
    </tr></thead>
    <tbody>
    ${links.map(l=>{
      const pct=Math.max(3,(l.clicks/max)*100);
      return `<tr>
        <td class="td-code">${x(l.shortCode)}</td>
        <td class="td-url"><a href="${xa(l.originalUrl)}" target="_blank" title="${xa(l.originalUrl)}">${x(trunc(l.originalUrl,38))}</a></td>
        <td>${badge(l)}</td>
        <td style="color:var(--muted);font-size:11px">${fmtDate(l.createdAt)}</td>
        <td class="td-clicks">${l.clicks}<div class="bar"><div class="bar-fill" style="width:${pct}%"></div></div></td>
        <td style="text-align:right;white-space:nowrap">
          <button class="btn-icon" onclick="toggleDrawer('${xa(l.shortCode)}')">ðŸ“Š</button>
          <button class="btn-icon" style="margin-left:4px" onclick="copyCode('${xa(l.shortUrl)}',this)">âŽ˜</button>
          <button class="btn-icon del" style="margin-left:4px" onclick="del('${xa(l.shortCode)}')">ðŸ—‘</button>
        </td>
      </tr>
      <tr id="dr-${x(l.shortCode)}" class="drawer-row">
        <td colspan="6" style="padding:0">
          <div class="drawer">
            <div class="drawer-hd">
              <span class="drawer-title">ðŸ“Š Click log â€” ${x(l.shortCode)}</span>
              <button class="btn-icon" onclick="toggleDrawer('${xa(l.shortCode)}')">âœ•</button>
            </div>
            <div class="log" id="log-${x(l.shortCode)}"><div class="no-clicks">Loadingâ€¦</div></div>
          </div>
        </td>
      </tr>`;
    }).join('')}
    </tbody></table>`;
}

function badge(l) {
  if (l.isExpired) return `<span class="badge b-expired">Expired</span>`;
  if (!l.expiresAt) return `<span class="badge b-active">Active</span>`;
  const h=(new Date(l.expiresAt)-Date.now())/36e5;
  return h<24 ? `<span class="badge b-soon">Expires soon</span>` : `<span class="badge b-active">Active</span>`;
}

async function toggleDrawer(code) {
  const row=document.getElementById(`dr-${code}`);
  const log=document.getElementById(`log-${code}`);
  if (row.style.display==='table-row' && openCode===code) { row.style.display='none'; openCode=null; return; }
  if (openCode) { const r=document.getElementById(`dr-${openCode}`); if(r) r.style.display='none'; }
  row.style.display='table-row'; openCode=code;
  log.innerHTML='<div class="no-clicks">Loadingâ€¦</div>';
  try {
    const r=await fetch(`/api/links/${encodeURIComponent(code)}/analytics`); const j=await r.json();
    const events=j.data?.clickEvents||[];
    if (!events.length) { log.innerHTML='<div class="no-clicks">No clicks yet.</div>'; return; }
    log.innerHTML=events.map(e=>`<div class="ce">
      <span class="ce-time">${fmtFull(e.timestamp)}</span>
      <span class="ce-ua">${x(parseUA(e.userAgent))}</span>
      <span class="ce-ip">${x(e.ip||'?')}</span>
    </div>`).join('');
  } catch { log.innerHTML='<div class="no-clicks">Failed to load.</div>'; }
}

async function del(code) {
  if (!confirm(`Delete "${code}"?`)) return;
  try {
    const r=await fetch(`/api/links/${encodeURIComponent(code)}`,{method:'DELETE'}); const j=await r.json();
    if (r.ok) loadStats(); else alert(j.error||'Delete failed.');
  } catch { alert('Network error.'); }
}

function copyCode(url, btn) {
  navigator.clipboard.writeText(url).then(()=>{const o=btn.textContent;btn.textContent='âœ“';setTimeout(()=>btn.textContent=o,1500);});
}

// â”€â”€ API Docs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadApiDocs() {
  try {
    const r=await fetch('/api'); const j=await r.json();
    document.getElementById('apiPre').textContent=`${j.name}  â€”  v${j.version}
${'â”€'.repeat(52)}

ENDPOINTS
${Object.entries(j.endpoints).map(([ep,d])=>`  ${ep.padEnd(38)}${d}`).join('\n')}

${'â”€'.repeat(52)}

EXAMPLE â€” Shorten a URL
  POST /api/links
  Content-Type: application/json

  {
    "originalUrl": "https://example.com/very/long/path",
    "customCode":  "my-slug",           // optional
    "expiresAt":   "2025-12-31T23:59"   // optional ISO datetime
  }

  â†’ 201 Created
  {
    "success": true,
    "data": {
      "shortCode":   "my-slug",
      "shortUrl":    "http://localhost:3000/my-slug",
      "originalUrl": "https://example.com/...",
      "clicks":      0,
      "expiresAt":   "2025-12-31T23:59:00.000Z",
      "createdAt":   "2024-01-01T12:00:00.000Z"
    }
  }

EXAMPLE â€” Analytics
  GET /api/links/my-slug/analytics

  â†’ 200 OK
  {
    "success": true,
    "data": {
      "shortCode":   "my-slug",
      "totalClicks": 42,
      "clickEvents": [
        { "timestamp": "...", "ip": "127.0.0.1", "userAgent": "Chrome/125", "referer": null }
      ]
    }
  }

${'â”€'.repeat(52)}

ERROR FORMAT
  { "success": false, "error": "Human-readable message" }

STATUS CODES
  201  Created          â€” new link
  200  OK               â€” existing link (dedup) or successful read
  400  Bad Request      â€” invalid URL / bad custom code / past expiry
  404  Not Found        â€” code doesn't exist
  409  Conflict         â€” custom code already taken
  410  Gone             â€” link has expired
  429  Too Many Requests â€” rate limit hit
  500  Internal Error`;
  } catch { document.getElementById('apiPre').textContent='Could not load. Is the server running?'; }
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function x(s){
  return String(s)
  .replaceAll('&','&amp;')
  .replaceAll('<','&lt;')
  .replaceAll('>','&gt;');
}
function xa(s){
  return x(s)
  .replaceAll('"','&quot;');
}
function trunc(s,n){
  return s.length>n?s.slice(0,n)+'â€¦':s;
}
function fmtDate(iso){
  if(!iso) return'â€”';
   else return new Date(iso)
   .toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
  }
function fmtFull(iso){
  if(!iso)return'â€”';
  const d=new Date(iso);
  return d.toLocaleDateString(undefined,{month:'short',day:'numeric'})+' '+d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
}
function parseUA(ua){
  if(!ua||ua==='unknown')return'Unknown';
  if(/curl/i.test(ua))return'curl';
  if(/Postman/i.test(ua))return'Postman';
  const m=ua.match(/(Chrome|Firefox|Safari|Edge|OPR)[/\s]([\d.]+)/i);
  return m?`${m[1]} ${m[2].split('.')[0]}`:trunc(ua,42);
}

// Enter key on url field
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('longUrl').addEventListener('keydown',e=>{if(e.key==='Enter')shorten();});
  const dt=document.getElementById('expiresAt');
  dt.min=new Date().toISOString().slice(0,16);
  dt.value=new Date(Date.now()+3600000).toISOString().slice(0,16);
});
</script>
</body>
</html>
